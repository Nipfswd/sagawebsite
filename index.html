<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Half-3D Genshin-Like Mini Demo</title>
<style>
  body, html { margin: 0; padding: 0; overflow: hidden; background: #222; }
  canvas { display: block; background: #555; }
  #btn-attack, #btn-restart {
    position: fixed; bottom: 40px; border-radius: 50%; border: none; font-size: 24px; color: white; z-index: 10;
  }
  #btn-attack { right: 40px; width: 80px; height: 80px; background: rgba(255, 0, 0, 0.6); }
  #btn-restart { left: 50%; transform: translateX(-50%); top: 20px; width: 150px; height: 50px; background: #28a745; display: none; }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<button id="btn-attack">⚔️</button>
<button id="btn-restart">Restart</button>

<script>
(() => {
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
  window.addEventListener('resize', resize); resize();

  const attackBtn = document.getElementById('btn-attack');
  const restartBtn = document.getElementById('btn-restart');

  class Entity {
    constructor(x, y, z, size, color, health) {
      this.x = x; this.y = y; this.z = z;
      this.size = size; this.color = color;
      this.health = health; this.lastDamageTime = 0;
    }
    isAlive() { return this.health > 0; }
  }

  const player = new Entity(0, 0, 0, 1, '#00aaff', 5);
  player.isAttacking = false; player.attackTimer = 0;

  function createEnemies() {
    return [
      new Entity(5, 5, 0, 1, 'red', 3),
      new Entity(-4, 3, 0, 1, 'red', 4),
      new Entity(2, -5, 0, 1, 'red', 2)
    ];
  }
  let enemies = createEnemies();

  let keys = { w: false, a: false, s: false, d: false, attack: false };

  window.addEventListener('keydown', e => { keys[e.key.toLowerCase()] = true; });
  window.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });

  attackBtn.addEventListener('touchstart', e => { e.preventDefault(); keys.attack = true; });
  attackBtn.addEventListener('touchend', e => { e.preventDefault(); keys.attack = false; });

  restartBtn.addEventListener('click', () => resetGame());

  function resetGame() {
    player.x = 0; player.y = 0; player.z = 0;
    player.isAttacking = false; player.color = '#00aaff';
    player.health = 5;
    enemies = createEnemies();
    restartBtn.style.display = 'none';
  }

  function drawEntity(e) {
    const scale = 100 / (e.z + 5);
    const screenX = canvas.width/2 + e.x * scale;
    const screenY = canvas.height/2 - e.y * scale;
    const size = e.size * scale;

    ctx.fillStyle = e.color;
    ctx.beginPath();
    ctx.arc(screenX, screenY, size/2, 0, Math.PI*2);
    ctx.fill();

    // draw health bar
    ctx.fillStyle = 'black';
    ctx.fillRect(screenX - size/2, screenY - size/2 - 10, size, 5);
    ctx.fillStyle = 'lime';
    ctx.fillRect(screenX - size/2, screenY - size/2 - 10, size * (e.health / 5), 5);
  }

  function distance(a, b) {
    return Math.sqrt( (a.x - b.x)**2 + (a.y - b.y)**2 );
  }

  function gameLoop(timestamp) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if(player.isAlive()) {
      if(keys.w) player.y += 0.1;
      if(keys.s) player.y -= 0.1;
      if(keys.a) player.x -= 0.1;
      if(keys.d) player.x += 0.1;
    }

    // Handle attack
    if(keys.attack && !player.isAttacking) {
      player.isAttacking = true;
      player.attackTimer = timestamp;
    }
    if(player.isAttacking) {
      if(timestamp - player.attackTimer < 300) {
        player.color = '#ff5500';
      } else {
        player.isAttacking = false;
        player.color = '#00aaff';
      }
    }

    // Enemies AI
    for (let enemy of enemies) {
      if(!enemy.isAlive()) continue;

      if(player.isAlive()) {
        let dx = player.x - enemy.x;
        let dy = player.y - enemy.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if(dist > 0.5) {
          enemy.x += dx/dist * 0.05;
          enemy.y += dy/dist * 0.05;
        }

        // Enemy attacks player
        if(dist < 0.7) {
          if(timestamp - enemy.lastDamageTime > 500) {
            player.health--;
            enemy.lastDamageTime = timestamp;
          }
        }
      }

      // Player attacking enemies
      if(player.isAttacking && distance(player, enemy) < 1) {
        if(timestamp - enemy.lastDamageTime > 500) {
          enemy.health--;
          enemy.lastDamageTime = timestamp;
        }
      }
    }

    drawEntity(player);
    enemies.forEach(e => { if(e.isAlive()) drawEntity(e); });

    // Check if player dead
    if(player.health <= 0) {
      ctx.fillStyle = 'white';
      ctx.font = '48px sans-serif';
      ctx.fillText('You Died!', canvas.width/2 - 100, canvas.height/2);
      restartBtn.style.display = 'block';
    }

    requestAnimationFrame(gameLoop);
  }

  requestAnimationFrame(gameLoop);
})();
</script>

</body>
</html>
